name: Deploy to EC2 Workflow
on: [push]
jobs:
    github-job-demo:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Log in to Docker Container Registry
              run: echo ${{ secrets.DOCKER_HUB_TOKEN }} | docker login -u r0w3na --password-stdin
            - name: Build and push Docker image
              run: |
                 docker build . -t r0w3na/delimiter:${{ github.sha }}
                 docker push r0w3na/delimiter:${{ github.sha }}
            - name: Run container
              uses: appleboy/ssh-action@master
              with:
                host: '54.147.79.203'
                username: ubuntu
                key: ${{ secrets.DEPLOY_KEY }}
                port: 22
                script: |
                  docker stop $(docker ps -q)
                  docker run -d -p 5000:5000 r0w3na/delimiter:${{ github.sha }}
            - name: Publish SNS Topic
              uses: nothingalike/sns-publish-topic@v1.6
              with:
                MESSAGE: "message"
                TOPIC_ARN: ${{ secrets.SNS_TOPIC_ARN }}
              env:
                AWS_REGION: ${{ secrets.AWS_REGION }}
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}      
